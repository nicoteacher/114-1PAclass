<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æƒæåœ–ç‰‡â†’æ’­æ”¾å½±ç‰‡ Demo (OpenCV.js)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial, sans-serif; margin: 0; background:#0b0f14; color:#e6edf3; }
    header { padding: 16px 20px; background: #111827; position: sticky; top:0; z-index: 10; }
    h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; display: grid; gap: 16px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ .row { grid-template-columns: 1.2fr 1fr; } }
    video#cam { width: 100%; max-height: 60vh; background: #000; border-radius: 12px; }
    canvas { display:none; }
    .status { font-size: 14px; opacity: 0.8; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #374151; background:#0b1220; padding:8px 12px; border-radius:999px; }
    .ok { color:#10b981; }
    .warn { color:#f59e0b; }
    .err { color:#ef4444; }
    .actions { display:flex; flex-wrap: wrap; gap:8px; }
    button, input[type="file"]::file-selector-button { background:#1f2937; color:#e6edf3; border:1px solid #374151; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button:hover, input[type="file"]::file-selector-button:hover { background:#243040; }
    .player { aspect-ratio: 16/9; width: 100%; background:#000; border-radius: 12px; overflow: hidden; border:1px solid #1f2937; }
    .help { font-size: 13px; line-height: 1.5; opacity: .9; }
    a { color:#86c5ff; }
    .badge { font-size:12px; padding:4px 8px; background:#0b1220; border:1px solid #22314d; border-radius:999px; }
  </style>
</head>
<body>
  <header>
    <h1>æƒææŒ‡å®šåœ–ç‰‡ â†’ è‡ªå‹•é¡¯ç¤ºå½±ç‰‡ï¼ˆWeb ç‰ˆï¼Œå… Appï¼‰</h1>
  </header>
  <main>
    <section class="card row">
      <div>
        <div class="actions" style="margin-bottom:12px">
          <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
          <button id="stopBtn" disabled>åœæ­¢</button>
          <span class="badge">å¤šç›®æ¨™æ¨¡å¼ï¼šè«‹å°æº–ä»»ä¸€ç›®æ¨™åœ–ç‰‡</span>
        </div>
        <video id="cam" playsinline muted></video>
        <canvas id="frame"></canvas>
        <p class="status" id="status">
          <span class="pill warn">ğŸ” æ­£åœ¨ç­‰å¾…ç›¸æ©Ÿå•Ÿå‹•â€¦</span>
        </p>
        <div class="help">
          <p>æŠŠç›¸æ©Ÿå°æº–ã€Œç›®æ¨™åœ–ç‰‡ã€ï¼ˆå¤šç›®æ¨™ï¼ˆè¦‹ä¸‹æ–¹æ¸…å–®ï¼‰ï¼‰ã€‚ç•¶ç³»çµ±åˆ¤å®šç›¸ç¬¦ï¼Œå³æœƒé¡¯ç¤ºä¸‹æ–¹å½±ç‰‡ã€‚</p>
          <details>
            <summary>æˆ–æ”¹ç”¨ä¸Šå‚³ç…§ç‰‡æ¯”å°</summary>
            <input type="file" id="upload" accept="image/*" />
          </details>
        </div>
      </div>
      <div>
        <div class="player" id="player">
          <iframe id="yt" width="100%" height="100%" style="border:0" allow="autoplay; encrypted-media; picture-in-picture"
            src="about:blank" title="ç›®æ¨™å½±ç‰‡"></iframe>
        </div>
        <div class="help">
          <p>âœ… å‘½ä¸­å¾Œæœƒè¼‰å…¥è©²ç›®æ¨™å°æ‡‰çš„å½±ç‰‡ã€‚<br>
          ç›®å‰å‘½ä¸­ï¼š<code id="currentLabel">å°šæœªå‘½ä¸­</code><br>
          å½±ç‰‡é€£çµï¼š<code id="videoUrlText">(ç­‰å¾…å‘½ä¸­)</code></p>
          <details open>
            <summary>å·²è¼‰å…¥ç›®æ¨™æ¸…å–®</summary>
            <ul id="targetsList"></ul>
          </details>
        </div>
        <div class="help">
          <strong>å¦‚ä½•æ›æˆè‡ªå·±çš„å…§å®¹ï¼Ÿ</strong>
          <ol>
            <li>æŠŠä½ çš„ã€Œç›®æ¨™åœ–ç‰‡ã€å‘½åç‚º <code>target.jpg</code>ï¼Œèˆ‡æœ¬æª”æ¡ˆæ”¾åœ¨åŒä¸€è³‡æ–™å¤¾ã€‚</li>
            <li>æŠŠ <code>VIDEO_URL</code> æ”¹æˆä½ çš„ YouTube/Vimeo/è‡ªæ¶ MP4 æ’­æ”¾é ã€‚</li>
          </ol>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>åŸç†èªªæ˜ï¼ˆç°¡åŒ–ç‰ˆï¼‰</h3>
      <p class="help">ä½¿ç”¨ OpenCV.js çš„ ORB ç‰¹å¾µèˆ‡æš´åŠ›åŒ¹é…ï¼ˆHammingï¼‰ï¼Œåœ¨æ¯å¹€æ“·å–çš„å½±åƒä¸Šèˆ‡é›¢ç·šé å…ˆè¼‰å…¥çš„ç›®æ¨™åœ–ç‰‡åšç‰¹å¾µæ¯”å°ï¼›ç•¶è‰¯å¥½åŒ¹é…æ•¸è¶…éé–€æª»ï¼Œå°±åˆ¤å®šç‚ºã€Œå‘½ä¸­ã€ï¼Œè§¸ç™¼é¡¯ç¤ºå½±ç‰‡ã€‚æ­¤æ³•ç²¾ç°¡ã€å¯é›¢ç·šã€å…é›²ç«¯ï¼Œä½†æ¯” QR code æ›´åƒå…‰ç·šèˆ‡å½±åƒå“è³ªï¼Œå»ºè­°ç›®æ¨™åœ–æ¡ˆå…·æœ‰è¶³å¤ ç´‹ç†èˆ‡å°æ¯”ã€‚</p>
    </section>
  </main>

  <!-- OpenCV.js CDNï¼ˆéœ€å¯é€£ç¶²ï¼‰-->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  <script>
    // === å¤šç›®æ¨™è¨­å®šï¼ˆè«‹æ”¹é€™è£¡ï¼‰===
    // æ¯å€‹ç›®æ¨™ä¸€ç­†ï¼šimage ç‚ºæª”åï¼ˆèˆ‡æœ¬æª”åŒè³‡æ–™å¤¾ï¼‰ï¼Œlabel ç‚ºé¡¯ç¤ºåç¨±ï¼Œurl ç‚ºå°æ‡‰å½±ç‰‡é ï¼Œthreshold å¯ä¾åœ–åƒè¤‡é›œåº¦èª¿æ•´ï¼ˆå»ºè­° 14~28ï¼‰ã€‚
    const TARGETS = [
      { id:'t1', image:'70299.jpg', label:'ç›®æ¨™ A', url:'https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&playsinline=1', threshold:18 },
      // å¯ç¹¼çºŒæ–°å¢ï¼š{ id:'t3', image:'poster_C.jpg', label:'ç›®æ¨™ C', url:'https://ä½ çš„å½±ç‰‡é ', threshold:20 }
    ];

    // å…§éƒ¨ç‹€æ…‹
    let stream, running = false; let currentHitId = null; let cvReady = false;
    let detector, matcher;
    const loadedTargets = []; // {id,label,url,threshold,desc:Mat}

    // DOM
    const statusEl = document.getElementById('status');
    const cam = document.getElementById('cam');
    const frame = document.getElementById('frame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const yt = document.getElementById('yt');
    const currentLabelEl = document.getElementById('currentLabel');
    const videoUrlText = document.getElementById('videoUrlText');
    const targetsList = document.getElementById('targetsList');

    function setStatus(html){ statusEl.innerHTML = html; }
    function safeStop(){
      running = false;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      startBtn.disabled = false; stopBtn.disabled = true;
      setStatus('<span class="pill">â¹ï¸ å·²åœæ­¢</span>');
    }

    async function startCam(){
      if(!cvReady){ setStatus('<span class="pill warn">ğŸ“¦ å½±åƒæ¨¡çµ„å°šæœªå°±ç·’æˆ–ç›®æ¨™å°šæœªè¼‰å…¥â€¦</span>'); return; }
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        cam.srcObject = stream; await cam.play();
        frame.width = Math.floor(cam.videoWidth/2); frame.height = Math.floor(cam.videoHeight/2);
        running = true; startBtn.disabled = true; stopBtn.disabled = false;
        setStatus('<span class="pill">ğŸ“¸ ç›¸æ©Ÿå•Ÿå‹•ä¸­â€¦è«‹å°æº–ä»»ä¸€ç›®æ¨™åœ–ç‰‡</span>');
        loop();
      }catch(err){
        console.error(err);
        setStatus('<span class="pill err">ğŸš« ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š'+ err.message +'</span>');
      }
    }

    function computeGoodMatches(descScene, descTarget){
      const matchesVec = new cv.DMatchVectorVector();
      matcher.knnMatch(descScene, descTarget, matchesVec, 2);
      let good = 0;
      for(let i=0;i<matchesVec.size();i++){
        const m = matchesVec.get(i);
        if(m.size() >= 2){
          const a = m.get(0), b = m.get(1);
          if(a.distance < 0.75*b.distance) good++;
        }
        m.delete();
      }
      matchesVec.delete();
      return good;
    }

    function extractDesc(srcMat){
      const gray = new cv.Mat(); cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      const kps = new cv.KeyPointVector(); const des = new cv.Mat();
      detector.detectAndCompute(gray, new cv.Mat(), kps, des);
      gray.delete(); kps.delete();
      return des; // caller must delete
    }

    function loop(){
      if(!running) return;
      const ctx = frame.getContext('2d');
      ctx.drawImage(cam, 0, 0, frame.width, frame.height);
      const scene = cv.imread(frame);
      const sceneDesc = extractDesc(scene);
      scene.delete();

      // å°æ¯å€‹ç›®æ¨™åšæ¯”å°ï¼Œå–æœ€ä½³
      let best = {id:null, label:'', url:'', threshold:999, score:-1};
      for(const t of loadedTargets){
        const good = computeGoodMatches(sceneDesc, t.desc);
        if(good > best.score){ best = {id:t.id, label:t.label, url:t.url, threshold:t.threshold, score:good}; }
      }
      sceneDesc.delete();

      if(best.id){
        if(best.score >= best.threshold){
          if(currentHitId !== best.id){
            currentHitId = best.id;
            yt.src = best.url;
            currentLabelEl.textContent = `${best.label}ï¼ˆåŒ¹é…ï¼š${best.score}ï¼‰`;
            videoUrlText.textContent = best.url;
            setStatus('<span class="pill ok">âœ… å‘½ä¸­ï¼š'+best.label+'ï¼›åŒ¹é…é»ï¼š'+best.score+'</span>');
          } else {
            setStatus('<span class="pill ok">âœ… ç¶­æŒå‘½ä¸­ï¼š'+best.label+'ï¼ˆåŒ¹é…ï¼š'+best.score+'ï¼‰</span>');
          }
        } else {
          setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦æœ€ä½³ï¼š'+best.label+'ï¼ˆè‰¯å¥½åŒ¹é…ï¼š'+best.score+' / é–€æª» '+best.threshold+'ï¼‰</span>');
        }
      } else {
        setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦å°šç„¡çµæœ</span>');
      }

      setTimeout(()=>requestAnimationFrame(loop), 220);
    }

    function renderTargetsList(){
      if(!targetsList) return;
      targetsList.innerHTML = '';
      for(const t of loadedTargets){
        const li = document.createElement('li');
        li.innerHTML = `<code>${t.label}</code> â†’ <code>${t.url}</code>ï¼ˆé–€æª» ${t.threshold}ï¼‰`;
        targetsList.appendChild(li);
      }
    }

    function onOpenCvReady(){
      cv['onRuntimeInitialized'] = async () => {
        detector = new cv.ORB();
        matcher = new cv.BFMatcher(cv.NORM_HAMMING, false);

        // è¼‰å…¥æ‰€æœ‰ç›®æ¨™ä¸¦è¨ˆç®—ç‰¹å¾µ
        const loads = TARGETS.map(cfg => new Promise((resolve, reject) => {
          const img = new Image(); img.src = cfg.image;
          img.onload = () => {
            const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img,0,0);
            const mat = cv.imread(c);
            const desc = extractDesc(mat); mat.delete();
            loadedTargets.push({ id:cfg.id, label:cfg.label, url:cfg.url, threshold:cfg.threshold ?? 18, desc });
            resolve();
          };
          img.onerror = () => reject(new Error('æ‰¾ä¸åˆ° '+cfg.image));
        }));

        try{
          await Promise.all(loads);
          cvReady = true;
          renderTargetsList();
          setStatus('<span class="pill ok">ğŸ§© å·²è¼‰å…¥ '+loadedTargets.length+' å€‹ç›®æ¨™ç‰¹å¾µï¼Œéš¨æ™‚å¯ã€Œå•Ÿå‹•ç›¸æ©Ÿã€ã€‚</span>');
        }catch(e){
          console.error(e);
          setStatus('<span class="pill err">âš ï¸ æœ‰ç›®æ¨™åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š'+e.message+'</span>');
        }
      };
    }

    // äº‹ä»¶
    startBtn.addEventListener('click', startCam);
    stopBtn.addEventListener('click', safeStop);

    // ä¸Šå‚³éœæ…‹åœ–ç‰‡æ¯”å°
    const uploadEl = document.getElementById('upload');
    if(uploadEl){
      uploadEl.addEventListener('change', async (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
        const c = document.createElement('canvas');
        const MAXW = 720; const scale = Math.min(1, MAXW / img.width);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        const mat = cv.imread(c);
        const sceneDesc = extractDesc(mat); mat.delete();
        let best = {id:null, label:'', url:'', threshold:999, score:-1};
        for(const t of loadedTargets){
          const good = computeGoodMatches(sceneDesc, t.desc);
          if(good > best.score){ best = {id:t.id, label:t.label, url:t.url, threshold:t.threshold, score:good}; }
        }
        sceneDesc.delete();
        if(best.id && best.score >= best.threshold){
          currentHitId = best.id; yt.src = best.url;
          currentLabelEl.textContent = `${best.label}ï¼ˆåŒ¹é…ï¼š${best.score}ï¼‰`;
          videoUrlText.textContent = best.url;
          setStatus('<span class="pill ok">âœ… ä¸Šå‚³åœ–ç‰‡å‘½ä¸­ï¼š'+best.label+'ï¼›åŒ¹é…ï¼š'+best.score+'</span>');
        } else if(best.id){
          setStatus('<span class="pill">ğŸ” ä¸Šå‚³åœ–ç‰‡æœ€ä½³ï¼š'+best.label+'ï¼ˆè‰¯å¥½åŒ¹é…ï¼š'+best.score+' / é–€æª» '+best.threshold+'ï¼‰</span>');
        } else {
          setStatus('<span class="pill">ğŸ” ä¸Šå‚³åœ–ç‰‡æ¯”å°ç„¡çµæœ</span>');
        }
      });
    }

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) safeStop(); });
  </script>
  <script>
    // === å¯è‡ªè¨‚ ===
    const VIDEO_URL = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&playsinline=1";
    document.getElementById('videoUrlText').textContent = VIDEO_URL;

    // å…§éƒ¨ç‹€æ…‹
    let stream, running = false, hit = false;
    let cvReady = false, targetMat, targetKeypoints, targetDescriptors;
    let detector, matcher;

    const statusEl = document.getElementById('status');
    const cam = document.getElementById('cam');
    const frame = document.getElementById('frame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const yt = document.getElementById('yt');

    function setStatus(html){ statusEl.innerHTML = html; }
    function safeStop(){
      running = false;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      startBtn.disabled = false; stopBtn.disabled = true;
      setStatus('<span class="pill">â¹ï¸ å·²åœæ­¢</span>');
    }

    async function startCam(){
      if(!cvReady){ setStatus('<span class="pill warn">ğŸ“¦ æ­£åœ¨è¼‰å…¥å½±åƒæ¨¡çµ„â€¦</span>'); return; }
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        cam.srcObject = stream; await cam.play();
        const w = cam.videoWidth, h = cam.videoHeight;
        frame.width = Math.floor(w/2); frame.height = Math.floor(h/2); // é™è§£æåº¦åŠ é€Ÿ
        running = true; startBtn.disabled = true; stopBtn.disabled = false;
        setStatus('<span class="pill">ğŸ“¸ ç›¸æ©Ÿå•Ÿå‹•ä¸­â€¦è«‹å°æº–ç›®æ¨™åœ–ç‰‡</span>');
        loop();
      }catch(err){
        console.error(err);
        setStatus('<span class="pill err">ğŸš« ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š'+ err.message +'</span>');
      }
    }

    function computeGoodMatches(desc1, desc2){
      const matches = new cv.DMatchVector();
      const matchesVec = new cv.DMatchVectorVector();
      // KNN = 2ï¼Œåš ratio test
      matcher.knnMatch(desc1, desc2, matchesVec, 2);
      let good = 0;
      for(let i=0; i<matchesVec.size(); i++){
        const m = matchesVec.get(i);
        if(m.size() >= 2){
          const a = m.get(0), b = m.get(1);
          if(a.distance < 0.75 * b.distance) good++;
        }
        m.delete();
      }
      matches.delete(); matchesVec.delete();
      return good;
    }

    function detectOnce(srcMat){
      const gray = new cv.Mat();
      cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      const kps = new cv.KeyPointVector();
      const des = new cv.Mat();
      detector.detectAndCompute(gray, new cv.Mat(), kps, des);
      const good = computeGoodMatches(des, targetDescriptors);
      gray.delete(); kps.delete(); des.delete();
      return good;
    }

    function loop(){
      if(!running) return;
      const ctx = frame.getContext('2d');
      ctx.drawImage(cam, 0, 0, frame.width, frame.height);
      const src = cv.imread(frame);
      const good = detectOnce(src);
      src.delete();

      const THRESHOLD = 18; // å¯ä¾ç›®æ¨™åœ–è¤‡é›œåº¦èª¿æ•´
      if(good >= THRESHOLD && !hit){
        hit = true;
        setStatus('<span class="pill ok">âœ… å‘½ä¸­ï¼åŒ¹é…é»ï¼š'+good+'ï¼Œå·²é¡¯ç¤ºå½±ç‰‡</span>');
        yt.src = VIDEO_URL;
      } else if(!hit) {
        setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦è‰¯å¥½åŒ¹é…ï¼š'+good+'</span>');
      }
      // é™ä½é »ç‡ä»¥çœé›»ï¼šæ¯ 200ms æª¢æ¸¬ä¸€æ¬¡
      setTimeout(()=>requestAnimationFrame(loop), 200);
    }

    function onOpenCvReady(){
      cv['onRuntimeInitialized'] = () => {
        // æº–å‚™ ORB èˆ‡ BFMatcher
        detector = new cv.ORB();
        matcher = new cv.BFMatcher(cv.NORM_HAMMING, false);
        // è¼‰å…¥ç›®æ¨™åœ–ç‰‡
        const img = new Image();
        img.src = 'target.jpg';
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = img.width; c.height = img.height;
          c.getContext('2d').drawImage(img, 0, 0);
          const mat = cv.imread(c);
          const gray = new cv.Mat();
          cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
          targetKeypoints = new cv.KeyPointVector();
          targetDescriptors = new cv.Mat();
          detector.detectAndCompute(gray, new cv.Mat(), targetKeypoints, targetDescriptors);
          mat.delete(); gray.delete();
          targetMat = true;
          cvReady = true;
          setStatus('<span class="pill ok">ğŸ§© å½±åƒæ¨¡çµ„å°±ç·’ï¼Œå·²è¼‰å…¥ç›®æ¨™ç‰¹å¾µã€‚å¯æŒ‰ã€Œå•Ÿå‹•ç›¸æ©Ÿã€ã€‚</span>');
        };
        img.onerror = () => setStatus('<span class="pill err">âš ï¸ æ‰¾ä¸åˆ° target.jpgï¼Œè«‹æŠŠç›®æ¨™åœ–ç‰‡æ”¾åœ¨åŒè³‡æ–™å¤¾ã€‚</span>');
      };
    }

    // äº‹ä»¶
    startBtn.addEventListener('click', startCam);
    stopBtn.addEventListener('click', safeStop);
    document.getElementById('upload').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const img = new Image(); img.src = URL.createObjectURL(file);
      await img.decode();
      const c = document.createElement('canvas');
      const MAXW = 720; const scale = Math.min(1, MAXW / img.width);
      c.width = img.width * scale; c.height = img.height * scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const mat = cv.imread(c);
      const good = detectOnce(mat);
      mat.delete();
      if(good >= 18 && !hit){
        hit = true; yt.src = VIDEO_URL;
        setStatus('<span class="pill ok">âœ… ä¸Šå‚³åœ–ç‰‡å‘½ä¸­ï¼ŒåŒ¹é…é»ï¼š'+good+'ï¼›å·²é¡¯ç¤ºå½±ç‰‡</span>');
      } else {
        setStatus('<span class="pill">ğŸ” ä¸Šå‚³åœ–ç‰‡æ¯”å°è‰¯å¥½åŒ¹é…ï¼š'+good+'ï¼ˆé–€æª» 18ï¼‰</span>');
      }
    });

    // è‡ªå‹•æš«åœé é¢é›¢é–‹æ™‚çš„ç›¸æ©Ÿ
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) safeStop(); });
  </script>
</body>
</html>

