<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‡ºç£æ„Ÿæ€§ï¼è‡ºç£ç‰¹è‰²äººç‰©å‹•èµ·ä¾†</title>
  <style>
    /* === å…¨æ–°ä»‹é¢ä¿®æ”¹ï¼šè‡ºç£æ„Ÿæ€§ï¼æ´»æ½‘æ©˜è‰²é¢¨æ ¼ === */
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial, sans-serif; 
      margin: 0; 
      background: rgb(255, 237, 204); /* æ·¡ç±³é»ƒè‰²èƒŒæ™¯ */
      color: #333; /* æ·±è‰²æ–‡å­— */
    }
    header { 
      padding: 16px 20px; 
      background: rgb(255, 105, 0); /* é®®è±”æ©˜è‰² */
      color: #fff; /* ç™½è‰²æ¨™é¡Œæ–‡å­— */
      position: sticky; 
      top:0; 
      z-index: 10; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { font-size: 20px; margin: 0; }
    main { padding: 16px; display: grid; gap: 16px; }
    .card { 
      background: #fff; /* å¡ç‰‡èƒŒæ™¯ç™½è‰² */
      border: 1px solid rgb(255, 171, 105); /* æ©˜è‰²é‚Šæ¡† */
      border-radius: 14px; 
      padding: 16px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ .row { grid-template-columns: 1.2fr 1fr; } }
    video#cam { 
      width: 100%; 
      max-height: 60vh; 
      background: #000; 
      border-radius: 12px; 
    }
    canvas { display:none; }
    
    /* 2. ç‹€æ…‹è¨Šæ¯ç§»åˆ°å³ä¸‹è§’ï¼Œä¸¦ç¸®å°å­—é«” */
    .status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 12px; /* å¾ 14px ç¸®å° */
      opacity: 0.9;
      z-index: 20; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    }
    
    .pill { 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      border:1px solid rgb(255, 171, 105); /* æ©˜è‰²é‚Šæ¡† */
      background: rgb(255, 218, 179); /* æ·¡æ©˜è‰²èƒŒæ™¯ */
      color: #555; /* æ·±è‰²æ–‡å­— */
      padding:8px 12px; 
      border-radius:999px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* å¢åŠ ä¸€é»é™°å½± */
    }
    .ok { color: #28a745; } /* ç¶ è‰² */
    .warn { color: #ffc107; } /* é»ƒè‰² */
    .err { color: #dc3545; } /* ç´…è‰² */
    
    .actions { display:flex; flex-wrap: wrap; gap:8px; }
    button { 
      background: rgb(255, 105, 0); /* é®®è±”æ©˜è‰²æŒ‰éˆ• */
      color: #fff; /* ç™½è‰²æŒ‰éˆ•æ–‡å­— */
      border:1px solid rgb(200, 80, 0); /* æ·±æ©˜è‰²é‚Šæ¡† */
      padding:10px 12px; 
      border-radius:10px; 
      cursor:pointer; 
      font-weight: bold;
    }
    button:hover { background: rgb(200, 80, 0); } /* æŒ‰éˆ•hoverè®Šæ·± */
    .player { aspect-ratio: 16/9; width: 100%; background:#000; border-radius: 12px; overflow: hidden; border:1px solid rgb(255, 171, 105); }
    .help { font-size: 13px; line-height: 1.5; opacity: .9; color: #555; }
    a { color:#007bff; }
    .badge { 
      font-size:12px; 
      padding:4px 8px; 
      background: rgb(255, 218, 179); /* æ·¡æ©˜è‰²èƒŒæ™¯ */
      border:1px solid rgb(255, 171, 105); /* æ©˜è‰²é‚Šæ¡† */
      border-radius:999px; 
      color: #555;
    }
    
    /* 1. æç¤ºèªæ¨£å¼ (ç²—é«”, ç„¡é‚Šæ¡†) */
    .instruction-text {
      font-weight: bold;
      text-align: center;
      margin-top: 12px;
      color: #333;
    }
    
    /* 4. é…å°æˆåŠŸæ–‡å­—æ¨£å¼ (ç²‰ç´…, ç²—é«”) */
    .success-message {
      color: #E5357A; /* ç²‰ç´…è‰² */
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>è‡ºç£æ„Ÿæ€§ï¼è‡ºç£ç‰¹è‰²äººç‰©å‹•èµ·ä¾†</h1>
  </header>
  <main>
    <section class="card row">
      <div>
        <div class="actions" style="margin-bottom:12px">
          <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
          <button id="stopBtn" disabled>åœæ­¢</button>
          <!-- 1. æç¤ºèªå·²ç§»åˆ° video ä¸‹æ–¹ -->
        </div>
        <video id="cam" playsinline muted></video>
        
        <!-- 1. æç¤ºèªç§»åˆ°é€™è£¡ï¼Œä¸¦ä¿®æ”¹æ¨£å¼ -->
        <p class="instruction-text">å°æº–ä»»ä¸€äººç‰©ç…§ç‰‡ï¼Œä¸‹é¢å¯ä»¥çœ‹åˆ°äººç‰©å‹•èµ·ä¾†å“¦</p>
        
        <canvas id="frame"></canvas>
        
        <!-- 3. æç¤ºæ–‡å­—å·²ç§»é™¤ -->
      </div>
      <div>
        <div class="player" id="player">
          <iframe id="yt" width="100%" height="100%" style="border:0" allow="autoplay; encrypted-media; picture-in-picture"
            src="about:blank" title="äººç‰©å‹•èµ·ä¾†å½±ç‰‡"></iframe>
        </div>
        <div class="help">
          <!-- 4. ä¿®æ”¹é…å°æˆåŠŸæ–‡å­— & æ¨£å¼ -->
          <p class="success-message">âœ…é…å°æˆåŠŸï¼Œå°±æœƒçœ‹åˆ°ã€Œå¯æ„›çš„è‡ºç£äººç‰©ã€å‹•èµ·ä¾†å“¦ï¼<br>
          ç›®å‰é…å°ï¼š<code id="currentLabel">å°šæœªé…å°</code><br>
          å°ç£äººç‰©å‹•èµ·ä¾†ï¼š<code id="videoUrlText">(ç­‰å¾…é…å°)</code></p>
          <details open>
            <summary>å·²è¼‰å…¥ç›¸ç‰‡æ¸…å–®</summary>
            <ul id="targetsList"></ul>
          </details>
        </div>
      </div>
    </section>

    <!-- 2. ç‹€æ…‹è¨Šæ¯ç§»åˆ° main çš„çµå°¾ (æœƒè¢« CSS å®šä½åˆ°å³ä¸‹è§’) -->
    <p class="status" id="status">
      <span class="pill warn">ğŸ” æ­£åœ¨ç­‰å¾…ç›¸æ©Ÿå•Ÿå‹•â€¦</span>
    </p>
  </main>

  <!-- OpenCV.js CDNï¼ˆéœ€å¯é€£ç¶²ï¼‰--><script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  
  <script>
    // === å¤šç›¸ç‰‡è¨­å®šï¼ˆè«‹æ”¹é€™è£¡ï¼‰===
    // image ç‚ºæª”åï¼ˆéœ€èˆ‡ index.html ä¸€èµ·ä¸Šå‚³åˆ° GitHubï¼‰
    // url å¿…é ˆæ˜¯ "embed" æ ¼å¼çš„å½±ç‰‡ç¶²å€
    const TARGETS = [
      { id:'t1', image:'70299.jpg', label:'ç›¸ç‰‡ A', url:'https://www.youtube.com/embed/kJrUlfrioGk?autoplay=1&mute=1&playsinline=1', threshold:18 },
      { id:'t2', image:'70202.jpg', label:'ç›¸ç‰‡ B', url:'https://www.youtube.com/embed/VhvUABwtinE?autoplay=1&mute=1&playsinline=1', threshold:18 },
      { id:'t3', image:'70204.jpg', label:'ç›¸ç‰‡ C', url:'https://www.youtube.com/embed/1AorgPxuoAQ?autoplay=1&mute=1&playsinline=1', threshold:18 }, 
      { id:'t4', image:'70211.jpg', label:'ç›¸ç‰‡ D', url:'https://www.youtube.com/embed/-U_GWXq5zks?autoplay=1&mute=1&playsinline=1', threshold:18 }
      // å¯ç¹¼çºŒæ–°å¢ï¼š{ id:'t5', image:'poster_E.jpg', label:'ç›¸ç‰‡ E', url:'https...', threshold:20 }
    ];

    // å…§éƒ¨ç‹€æ…‹
    let stream, running = false; let currentHitId = null; let cvReady = false;
    let detector, matcher;
    const loadedTargets = []; // {id,label,url,threshold,desc:Mat}

    // DOM
    const statusEl = document.getElementById('status');
    const cam = document.getElementById('cam');
    const frame = document.getElementById('frame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const yt = document.getElementById('yt');
    const currentLabelEl = document.getElementById('currentLabel');
    const videoUrlText = document.getElementById('videoUrlText');
    const targetsList = document.getElementById('targetsList');

    function setStatus(html){ statusEl.innerHTML = html; }
    function safeStop(){
      running = false;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      startBtn.disabled = false; stopBtn.disabled = true;
      setStatus('<span class="pill">â¹ï¸ å·²åœæ­¢</span>');
    }

    async function startCam(){
      if(!cvReady || loadedTargets.length === 0){ 
        setStatus('<span class="pill warn">ğŸ“¦ å½±åƒæ¨¡çµ„å°šæœªå°±ç·’æˆ–ç›¸ç‰‡å°šæœªè¼‰å…¥â€¦</span>'); 
        if (!cvReady) console.warn('OpenCV.js å°šæœªå°±ç·’');
        if (loadedTargets.length === 0) console.warn('æ²’æœ‰æˆåŠŸè¼‰å…¥ä»»ä½•ç›¸ç‰‡');
        return; 
      }
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        cam.srcObject = stream; await cam.play();
        
        const videoTrack = stream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        const w = settings.width || 640;
        const h = settings.height || 480;

        frame.width = Math.floor(w/2); 
        frame.height = Math.floor(h/2);

        running = true; startBtn.disabled = true; stopBtn.disabled = false;
        setStatus('<span class="pill">ğŸ“¸ ç›¸æ©Ÿå•Ÿå‹•ä¸­â€¦è«‹å°æº–ä»»ä¸€ç›¸ç‰‡</span>');
        loop();
      }catch(err){
        console.error(err);
        let msg = err.message;
        if(err.name === 'NotAllowedError') {
          msg = 'æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ã€‚';
        } else if (err.name === 'NotFoundError') {
          msg = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          msg = 'ç›¸æ©Ÿå¯èƒ½æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨ä¸­ã€‚';
        } else if (err.name === 'SecurityError') {
          msg = 'ç›¸æ©Ÿæ¬Šé™åƒ…é™æ–¼ HTTPS å®‰å…¨é€£ç·šã€‚';
        }
        setStatus(`<span class="pill err">ğŸš« ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š${msg}</span>`);
      }
    }

    function computeGoodMatches(descScene, descTarget){
      const matchesVec = new cv.DMatchVectorVector();
      try {
        if (descScene.empty() || descTarget.empty()) {
            matchesVec.delete();
            return 0;
        }
        matcher.knnMatch(descScene, descTarget, matchesVec, 2);
      } catch(e) {
        console.warn("knnMatch error", e);
        matchesVec.delete();
        return 0; 
      }
      
      let good = 0;
      for(let i=0;i<matchesVec.size();i++){
        const m = matchesVec.get(i);
        if(m.size() >= 2){
          const a = m.get(0), b = m.get(1);
          if(a.distance < 0.75*b.distance) good++;
        }
        m.delete();
      }
      matchesVec.delete();
      return good;
    }

    function extractDesc(srcMat){
      const gray = new cv.Mat(); cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      const kps = new cv.KeyPointVector(); const des = new cv.Mat();
      try {
        detector.detectAndCompute(gray, new cv.Mat(), kps, des);
      } catch(e) {
        console.error("detectAndCompute error:", e);
      }
      gray.delete(); kps.delete();
      return des; // caller must delete
    }

    function loop(){
      if(!running) return;
      const ctx = frame.getContext('2d');
      ctx.drawImage(cam, 0, 0, frame.width, frame.height);
      
      const scene = cv.imread(frame);
      const sceneDesc = extractDesc(scene);
      scene.delete();

      let best = {id:null, label:'', url:'', threshold:999, score:-1};
      for(const t of loadedTargets){
        const good = computeGoodMatches(sceneDesc, t.desc);
        if(good > best.score){ best = {id:t.id, label:t.label, url:t.url, threshold:t.threshold, score:good}; }
      }
      sceneDesc.delete();

      if(best.id){
        if(best.score >= best.threshold){
          if(currentHitId !== best.id){
            currentHitId = best.id;
            yt.src = best.url;
            currentLabelEl.textContent = `${best.label}ï¼ˆåŒ¹é…ï¼š${best.score}ï¼‰`;
            videoUrlText.textContent = best.url;
            setStatus('<span class="pill ok">âœ… é…å°ï¼š'+best.label+'ï¼›åŒ¹é…é»ï¼š'+best.score+'</span>');
          } else {
            setStatus('<span class="pill ok">âœ… ç¶­æŒé…å°ï¼š'+best.label+'ï¼ˆåŒ¹é…ï¼š'+best.score+'ï¼‰</span>');
          }
        } else {
          currentHitId = null; // åŒ¹é…æ•¸ä¸è¶³ï¼Œé‡ç½®
          setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦æœ€ä½³ï¼š'+best.label+'ï¼ˆè‰¯å¥½åŒ¹é…ï¼š'+best.score+' / é–€æª» '+best.threshold+'ï¼‰</span>');
        }
      } else {
        currentHitId = null; // ç„¡åŒ¹é…
        setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦å°šç„¡çµæœ</span>');
      }

      setTimeout(()=>requestAnimationFrame(loop), 220);
    }

    function renderTargetsList(){
      if(!targetsList) return;
      targetsList.innerHTML = '';
      if(loadedTargets.length === 0) {
        targetsList.innerHTML = '<li>å°šæœªè¼‰å…¥ä»»ä½•ç›¸ç‰‡ã€‚</li>';
        return;
      }
      for(const t of loadedTargets){
        const li = document.createElement('li');
        li.innerHTML = `<code>${t.label}</code> â†’ <code>...${t.url.split('?')[0].slice(-20)}</code>ï¼ˆé–€æª» ${t.threshold}ï¼‰`;
        targetsList.appendChild(li);
      }
    }

    function onOpenCvReady(){
      cv['onRuntimeInitialized'] = async () => {
        try {
          detector = new cv.ORB();
          matcher = new cv.BFMatcher(cv.NORM_HAMMING, false);
        } catch(e) {
          console.error("OpenCV init error", e);
          setStatus('<span class="pill err">âš ï¸ OpenCV æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—ã€‚</span>');
          return;
        }

        const loads = TARGETS.map(cfg => new Promise((resolve, reject) => {
          const img = new Image();
          img.src = cfg.image;
          
          img.onload = () => {
            const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img,0,0);
            const mat = cv.imread(c);
            const desc = extractDesc(mat); 
            mat.delete();
            
            if(desc.empty()) {
              console.warn(`'${cfg.label}' (${cfg.image}) ç„¡æ³•æå–ç‰¹å¾µã€‚åœ–ç‰‡æ˜¯å¦å¤ªæ¨¡ç³Šæˆ–å¤ªç°¡å–®ï¼Ÿ`);
              reject(new Error(`ç„¡æ³•æå– ${cfg.label} çš„ç‰¹å¾µ`));
            } else {
              loadedTargets.push({ id:cfg.id, label:cfg.label, url:cfg.url, threshold:cfg.threshold ?? 18, desc });
              resolve();
            }
          };
          img.onerror = () => {
            console.error(`æ‰¾ä¸åˆ°ç›¸ç‰‡ï¼š'${cfg.image}'ã€‚è«‹æª¢æŸ¥ GitHub ä¸Šçš„æª”åå¤§å°å¯«æ˜¯å¦å®Œå…¨ä¸€è‡´ã€‚`);
            reject(new Error(`æ‰¾ä¸åˆ° ${cfg.image}`));
          };
        }));

        try{
          await Promise.all(loads);
          cvReady = true;
          renderTargetsList();
          setStatus('<span class="pill ok">ğŸ§© å·²è¼‰å…¥ '+loadedTargets.length+' å€‹ç›¸ç‰‡ç‰¹å¾µï¼Œéš¨æ™‚å¯ã€Œå•Ÿå‹•ç›¸æ©Ÿã€ã€‚</span>');
        }catch(e){
          console.error(e);
          setStatus(`<span class="pill err">âš ï¸ æœ‰ç›¸ç‰‡è¼‰å…¥å¤±æ•—ï¼š${e.message}ã€‚è«‹æª¢æŸ¥æª”åã€‚</span>`);
          renderTargetsList(); 
        }
      };
    }

    // äº‹ä»¶
    startBtn.addEventListener('click', startCam);
    stopBtn.addEventListener('click', safeStop);

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) safeStop(); });
  </script>
  
</body>
</html>
