<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æƒæåœ–ç‰‡â†’æ’­æ”¾å½±ç‰‡ (OpenCV.js å¤šç›®æ¨™ç‰ˆ)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial, sans-serif; margin: 0; background:#0b0f14; color:#e6edf3; }
    header { padding: 16px 20px; background: #111827; position: sticky; top:0; z-index: 10; }
    h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; display: grid; gap: 16px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ .row { grid-template-columns: 1.2fr 1fr; } }
    /* ä¿®æ­£ï¼šè®“æ”å½±æ©Ÿç•«é¢é¡åƒç¿»è½‰ï¼Œæ›´ç¬¦åˆç›´è¦º */
    video#cam { 
      width: 100%; 
      max-height: 60vh; 
      background: #000; 
      border-radius: 12px; 
      transform: scaleX(-1); 
    }
    canvas { display:none; }
    .status { font-size: 14px; opacity: 0.8; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #374151; background:#0b1220; padding:8px 12px; border-radius:999px; }
    .ok { color:#10b981; }
    .warn { color:#f59e0b; }
    .err { color:#ef4444; }
    .actions { display:flex; flex-wrap: wrap; gap:8px; }
    button, input[type="file"]::file-selector-button { background:#1f2937; color:#e6edf3; border:1px solid #374151; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button:hover, input[type="file"]::file-selector-button:hover { background:#243040; }
    .player { aspect-ratio: 16/9; width: 100%; background:#000; border-radius: 12px; overflow: hidden; border:1px solid #1f2937; }
    .help { font-size: 13px; line-height: 1.5; opacity: .9; }
    a { color:#86c5ff; }
    .badge { font-size:12px; padding:4px 8px; background:#0b1220; border:1px solid #22314d; border-radius:999px; }
  </style>
</head>
<body>
  <header>
    <h1>æƒææŒ‡å®šåœ–ç‰‡ â†’ è‡ªå‹•é¡¯ç¤ºå½±ç‰‡ï¼ˆå¤šç›®æ¨™ç‰ˆï¼‰</h1>
  </header>
  <main>
    <section class="card row">
      <div>
        <div class="actions" style="margin-bottom:12px">
          <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
          <button id="stopBtn" disabled>åœæ­¢</button>
          <span class="badge">å¤šç›®æ¨™æ¨¡å¼ï¼šè«‹å°æº–ä»»ä¸€ç›®æ¨™åœ–ç‰‡</span>
        </div>
        <video id="cam" playsinline muted></video>
        <canvas id="frame"></canvas>
        <p class="status" id="status">
          <span class="pill warn">ğŸ” æ­£åœ¨ç­‰å¾…ç›¸æ©Ÿå•Ÿå‹•â€¦</span>
        </p>
        <div class="help">
          <p>æŠŠç›¸æ©Ÿå°æº–ã€Œç›®æ¨™åœ–ç‰‡ã€ï¼ˆè¦‹ä¸‹æ–¹æ¸…å–®ï¼‰ã€‚ç•¶ç³»çµ±åˆ¤å®šç›¸ç¬¦ï¼Œå³æœƒé¡¯ç¤ºä¸‹æ–¹å½±ç‰‡ã€‚</p>
          <details>
            <summary>æˆ–æ”¹ç”¨ä¸Šå‚³ç…§ç‰‡æ¯”å°</summary>
            <input type="file" id="upload" accept="image/*" />
          </details>
        </div>
      </div>
      <div>
        <div class="player" id="player">
          <iframe id="yt" width="100%" height="100%" style="border:0" allow="autoplay; encrypted-media; picture-in-picture"
            src="about:blank" title="ç›®æ¨™å½±ç‰‡"></iframe>
        </div>
        <div class="help">
          <p>âœ… å‘½ä¸­å¾Œæœƒè¼‰å…¥è©²ç›®æ¨™å°æ‡‰çš„å½±ç‰‡ã€‚<br>
          ç›®å‰å‘½ä¸­ï¼š<code id="currentLabel">å°šæœªå‘½ä¸­</code><br>
          å½±ç‰‡é€£çµï¼š<code id="videoUrlText">(ç­‰å¾…å‘½ä¸­)</code></p>
          <details open>
            <summary>å·²è¼‰å…¥ç›®æ¨™æ¸…å–®</summary>
            <ul id="targetsList"></ul>
          </details>
        </div>
        <!-- ç§»é™¤äº†èˆŠç‰ˆ "å¦‚ä½•æ›æˆè‡ªå·±çš„å…§å®¹ï¼Ÿ" çš„èªªæ˜ï¼Œå› ç‚ºå·²åœ¨æ­¤è™•å¯¦ç¾å¤šç›®æ¨™ -->
      </div>
    </section>

    <section class="card">
      <h3>åŸç†èªªæ˜ï¼ˆç°¡åŒ–ç‰ˆï¼‰</h3>
      <p class="help">ä½¿ç”¨ OpenCV.js çš„ ORB ç‰¹å¾µèˆ‡æš´åŠ›åŒ¹é…ï¼ˆHammingï¼‰ï¼Œåœ¨æ¯å¹€æ“·å–çš„å½±åƒä¸Šèˆ‡é›¢ç·šé å…ˆè¼‰å…¥çš„ç›®æ¨™åœ–ç‰‡åšç‰¹å¾µæ¯”å°ï¼›ç•¶è‰¯å¥½åŒ¹é…æ•¸è¶…éé–€æª»ï¼Œå°±åˆ¤å®šç‚ºã€Œå‘½ä¸­ã€ï¼Œè§¸ç™¼é¡¯ç¤ºå½±ç‰‡ã€‚æ­¤æ³•ç²¾ç°¡ã€å¯é›¢ç·šã€å…é›²ç«¯ï¼Œä½†æ¯” QR code æ›´åƒå…‰ç·šèˆ‡å½±åƒå“è³ªï¼Œå»ºè­°ç›®æ¨™åœ–æ¡ˆå…·æœ‰è¶³å¤ ç´‹ç†èˆ‡å°æ¯”ã€‚</p>
    </section>
  </main>

  <!-- OpenCV.js CDNï¼ˆéœ€å¯é€£ç¶²ï¼‰-->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  
  <!-- é€™æ˜¯å”¯ä¸€ä¸”æ­£ç¢ºçš„ Script å€å¡Š -->
  <script>
    // === å¤šç›®æ¨™è¨­å®šï¼ˆè«‹æ”¹é€™è£¡ï¼‰===
    // image ç‚ºæª”åï¼ˆéœ€èˆ‡ index.html ä¸€èµ·ä¸Šå‚³åˆ° GitHubï¼‰
    // url å¿…é ˆæ˜¯ "embed" æ ¼å¼çš„å½±ç‰‡ç¶²å€
    const TARGETS = [
      { id:'t1', image:'70299.jpg', label:'ç›®æ¨™ A', url:'https://www.youtube.com/embed/kJrUlfrioGk?autoplay=1&mute=1&playsinline=1', threshold:18 },
      { id:'t2', image:'70202.jpg', label:'ç›®æ¨™ B', url:'https://www.youtube.com/embed/VhvUABwtinE?autoplay=1&mute=1&playsinline=1', threshold:18 },
      { id:'t3', image:'70204.jpg', label:'ç›®æ¨™ C', url:'https://www.youtube.com/embed/1AorgPxuoAQ?autoplay=1&mute=1&playsinline=1', threshold:18 }, // <-- ä¿®æ­£ï¼šåŠ ä¸Šäº†é€—è™Ÿ
      { id:'t4', image:'70211.jpg', label:'ç›®æ¨™ D', url:'https://www.youtube.com/embed/-U_GWXq5zks?autoplay=1&mute=1&playsinline=1', threshold:18 }
      // å¯ç¹¼çºŒæ–°å¢ï¼š{ id:'t5', image:'poster_E.jpg', label:'ç›®æ¨™ E', url:'https:...', threshold:20 }
    ];

    // å…§éƒ¨ç‹€æ…‹
    let stream, running = false; let currentHitId = null; let cvReady = false;
    let detector, matcher;
    const loadedTargets = []; // {id,label,url,threshold,desc:Mat}

    // DOM
    const statusEl = document.getElementById('status');
    const cam = document.getElementById('cam');
    const frame = document.getElementById('frame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const yt = document.getElementById('yt');
    const currentLabelEl = document.getElementById('currentLabel');
    const videoUrlText = document.getElementById('videoUrlText');
    const targetsList = document.getElementById('targetsList');

    function setStatus(html){ statusEl.innerHTML = html; }
    function safeStop(){
      running = false;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      startBtn.disabled = false; stopBtn.disabled = true;
      setStatus('<span class="pill">â¹ï¸ å·²åœæ­¢</span>');
    }

    async function startCam(){
      // ä¿®æ­£ï¼šæª¢æŸ¥ loadedTargets.length æ˜¯å¦ > 0
      if(!cvReady || loadedTargets.length === 0){ 
        setStatus('<span class="pill warn">ğŸ“¦ å½±åƒæ¨¡çµ„å°šæœªå°±ç·’æˆ–ç›®æ¨™å°šæœªè¼‰å…¥â€¦</span>'); 
        // å¢åŠ æç¤ºï¼Œæª¢æŸ¥ Console
        if (!cvReady) console.warn('OpenCV.js å°šæœªå°±ç·’');
        if (loadedTargets.length === 0) console.warn('æ²’æœ‰æˆåŠŸè¼‰å…¥ä»»ä½•ç›®æ¨™åœ–ç‰‡');
        return; 
      }
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        cam.srcObject = stream; await cam.play();
        
        // é™ä½è§£æåº¦ä»¥æå‡æ•ˆèƒ½
        const videoTrack = stream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        const w = settings.width || 640;
        const h = settings.height || 480;

        frame.width = Math.floor(w/2); 
        frame.height = Math.floor(h/2);

        running = true; startBtn.disabled = true; stopBtn.disabled = false;
        setStatus('<span class="pill">ğŸ“¸ ç›¸æ©Ÿå•Ÿå‹•ä¸­â€¦è«‹å°æº–ä»»ä¸€ç›®æ¨™åœ–ç‰‡</span>');
        loop();
      }catch(err){
        console.error(err);
        let msg = err.message;
        if(err.name === 'NotAllowedError') {
          msg = 'æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ã€‚';
        } else if (err.name === 'NotFoundError') {
          msg = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          msg = 'ç›¸æ©Ÿå¯èƒ½æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨ä¸­ã€‚';
        } else if (err.name === 'SecurityError') {
          msg = 'ç›¸æ©Ÿæ¬Šé™åƒ…é™æ–¼ HTTPS å®‰å…¨é€£ç·šã€‚';
        }
        setStatus(`<span class="pill err">ğŸš« ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š${msg}</span>`);
      }
    }

    function computeGoodMatches(descScene, descTarget){
      const matchesVec = new cv.DMatchVectorVector();
      try {
        // ä¿®æ­£ï¼šæª¢æŸ¥ desc æ˜¯å¦ç‚ºç©º
        if (descScene.empty() || descTarget.empty()) {
            matchesVec.delete();
            return 0;
        }
        matcher.knnMatch(descScene, descTarget, matchesVec, 2);
      } catch(e) {
        console.warn("knnMatch error", e);
        matchesVec.delete();
        return 0; // æ¯”å°å¤±æ•—
      }
      
      let good = 0;
      for(let i=0;i<matchesVec.size();i++){
        const m = matchesVec.get(i);
        if(m.size() >= 2){
          const a = m.get(0), b = m.get(1);
          if(a.distance < 0.75*b.distance) good++;
        }
        m.delete();
      }
      matchesVec.delete();
      return good;
    }

    function extractDesc(srcMat){
      const gray = new cv.Mat(); cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      const kps = new cv.KeyPointVector(); const des = new cv.Mat();
      try {
        detector.detectAndCompute(gray, new cv.Mat(), kps, des);
      } catch(e) {
        console.error("detectAndCompute error:", e);
      }
      gray.delete(); kps.delete();
      return des; // caller must delete
    }

    function loop(){
      if(!running) return;
      const ctx = frame.getContext('2d');
      // ç¹ªè£½å½±åƒåˆ° canvas (é¡åƒç¿»è½‰ï¼Œä»¥åŒ¹é…æ”å½±æ©Ÿç•«é¢)
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(cam, -frame.width, 0, frame.width, frame.height);
      ctx.restore();
      
      const scene = cv.imread(frame);
      const sceneDesc = extractDesc(scene);
      scene.delete();

      // å°æ¯å€‹ç›®æ¨™åšæ¯”å°ï¼Œå–æœ€ä½³
      let best = {id:null, label:'', url:'', threshold:999, score:-1};
      for(const t of loadedTargets){
        const good = computeGoodMatches(sceneDesc, t.desc);
        if(good > best.score){ best = {id:t.id, label:t.label, url:t.url, threshold:t.threshold, score:good}; }
      }
      sceneDesc.delete();

      if(best.id){
        if(best.score >= best.threshold){
          if(currentHitId !== best.id){
            currentHitId = best.id;
            yt.src = best.url;
            currentLabelEl.textContent = `${best.label}ï¼ˆåŒ¹é…ï¼š${best.score}ï¼‰`;
            videoUrlText.textContent = best.url;
            setStatus('<span class="pill ok">âœ… å‘½ä¸­ï¼š'+best.label+'ï¼›åŒ¹é…é»ï¼š'+best.score+'</span>');
          } else {
            setStatus('<span class="pill ok">âœ… ç¶­æŒå‘½ä¸­ï¼š'+best.label+'ï¼ˆåŒ¹é…ï¼š'+best.score+'ï¼‰</span>');
          }
        } else {
          currentHitId = null; // åŒ¹é…æ•¸ä¸è¶³ï¼Œé‡ç½®
          setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦æœ€ä½³ï¼š'+best.label+'ï¼ˆè‰¯å¥½åŒ¹é…ï¼š'+best.score+' / é–€æª» '+best.threshold+'ï¼‰</span>');
        }
      } else {
        currentHitId = null; // ç„¡åŒ¹é…
        setStatus('<span class="pill">ğŸ” æ¯”å°ä¸­â€¦å°šç„¡çµæœ</span>');
      }

      setTimeout(()=>requestAnimationFrame(loop), 220);
    }

    function renderTargetsList(){
      if(!targetsList) return;
      targetsList.innerHTML = '';
      if(loadedTargets.length === 0) {
        targetsList.innerHTML = '<li>å°šæœªè¼‰å…¥ä»»ä½•ç›®æ¨™ã€‚</li>';
        return;
      }
      for(const t of loadedTargets){
        const li = document.createElement('li');
        // ä¿®æ­£ï¼šé¡¯ç¤º label
        li.innerHTML = `<code>${t.label}</code> â†’ <code>...${t.url.split('?')[0].slice(-20)}</code>ï¼ˆé–€æª» ${t.threshold}ï¼‰`;
        targetsList.appendChild(li);
      }
    }

    function onOpenCvReady(){
      cv['onRuntimeInitialized'] = async () => {
        try {
          detector = new cv.ORB();
          matcher = new cv.BFMatcher(cv.NORM_HAMMING, false);
        } catch(e) {
          console.error("OpenCV init error", e);
          setStatus('<span class="pill err">âš ï¸ OpenCV æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—ã€‚</span>');
          return;
        }

        // è¼‰å…¥æ‰€æœ‰ç›®æ¨™ä¸¦è¨ˆç®—ç‰¹å¾µ
        const loads = TARGETS.map(cfg => new Promise((resolve, reject) => {
          const img = new Image();
          // img.crossOrigin = "Anonymous"; // è¨»ï¼šåœ¨ GitHub Pages ä¸Šå› ç‚ºåŒæºï¼Œé€šå¸¸ä¸éœ€è¦
          img.src = cfg.image;
          
          img.onload = () => {
            const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img,0,0);
            const mat = cv.imread(c);
            const desc = extractDesc(mat); 
            mat.delete();
            
            if(desc.empty()) {
              console.warn(`'${cfg.label}' (${cfg.image}) ç„¡æ³•æå–ç‰¹å¾µã€‚åœ–ç‰‡æ˜¯å¦å¤ªæ¨¡ç³Šæˆ–å¤ªç°¡å–®ï¼Ÿ`);
              reject(new Error(`ç„¡æ³•æå– ${cfg.label} çš„ç‰¹å¾µ`));
            } else {
              loadedTargets.push({ id:cfg.id, label:cfg.label, url:cfg.url, threshold:cfg.threshold ?? 18, desc });
              resolve();
            }
          };
          img.onerror = () => {
            // é€™æ˜¯æœ€å¸¸è¦‹çš„éŒ¯èª¤ï¼
            console.error(`æ‰¾ä¸åˆ°åœ–ç‰‡ï¼š'${cfg.image}'ã€‚è«‹æª¢æŸ¥ GitHub ä¸Šçš„æª”åå¤§å°å¯«æ˜¯å¦å®Œå…¨ä¸€è‡´ã€‚`);
            reject(new Error(`æ‰¾ä¸åˆ° ${cfg.image}`));
          };
        }));

        try{
          await Promise.all(loads);
          cvReady = true;
          renderTargetsList();
          setStatus('<span class="pill ok">ğŸ§© å·²è¼‰å…¥ '+loadedTargets.length+' å€‹ç›®æ¨™ç‰¹å¾µï¼Œéš¨æ™‚å¯ã€Œå•Ÿå‹•ç›¸æ©Ÿã€ã€‚</span>');
        }catch(e){
          console.error(e);
          setStatus(`<span class="pill err">âš ï¸ æœ‰ç›®æ¨™åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š${e.message}ã€‚è«‹æª¢æŸ¥æª”åã€‚</span>`);
          renderTargetsList(); // é¡¯ç¤ºéƒ¨åˆ†è¼‰å…¥çš„
        }
      };
    }

    // äº‹ä»¶
    startBtn.addEventListener('click', startCam);
    stopBtn.addEventListener('click', safeStop);

    // ä¸Šå‚³éœæ…‹åœ–ç‰‡æ¯”å°
    const uploadEl = document.getElementById('upload');
    if(uploadEl){
      uploadEl.addEventListener('change', async (e)=>{
        if(!cvReady || loadedTargets.length === 0){
           setStatus('<span class="pill warn">ğŸ“¦ ç›®æ¨™å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚</span>');
           e.target.value = null; // é‡è¨­
           return;
        }
        const file = e.target.files[0]; if(!file) return;
        const img = new Image(); img.src = URL.createObjectURL(file); 
        await img.decode();
        
        const c = document.createElement('canvas');
        const MAXW = 720; const scale = Math.min(1, MAXW / img.width);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        
        const mat = cv.imread(c);
        const sceneDesc = extractDesc(mat); mat.delete();
        
        let best = {id:null, label:'', url:'', threshold:999, score:-1};
        for(const t of loadedTargets){
          const good = computeGoodMatches(sceneDesc, t.desc);
          if(good > best.score){ best = {id:t.id, label:t.label, url:t.url, threshold:t.threshold, score:good}; }
        }
        sceneDesc.delete();
        
        if(best.id && best.score >= best.threshold){
          currentHitId = best.id; yt.src = best.url;
          currentLabelEl.textContent = `${best.label}ï¼ˆåŒ¹é…ï¼š${best.score}ï¼‰`;
          videoUrlText.textContent = best.url;
          setStatus('<span class="pill ok">âœ… ä¸Šå‚³åœ–ç‰‡å‘½ä¸­ï¼š'+best.label+'ï¼›åŒ¹é…ï¼š'+best.score+'</span>');
        } else if(best.id){
          setStatus('<span class="pill">ğŸ” ä¸Šå‚³åœ–ç‰‡æœ€ä½³ï¼š'+best.label+'ï¼ˆè‰¯å¥½åŒ¹é…ï¼š'+best.score+' / é–€æª» '+best.threshold+'ï¼‰</span>');
        } else {
          setStatus('<span class="pill">ğŸ” ä¸Šå‚³åœ–ç‰‡æ¯”å°ç„¡çµæœ</span>');
        }
        e.target.value = null; // é‡è¨­
      });
    }

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) safeStop(); });
  </script>
  
  <!-- 
    ä¿®æ­£ï¼šåº•ä¸‹é‡è¤‡çš„ <script> å€å¡Šå·²è¢«åˆªé™¤ï¼Œ
    å®ƒå°è‡´äº† 'startCam' å’Œ 'onOpenCvReady' å‡½æ•¸è¢«éŒ¯èª¤åœ°è¦†è“‹ã€‚
  -->
</body>
</html>
